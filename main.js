
import { TwitchChat } from 'https://deno.land/x/tmi@v1.0.5/mod.ts';
import { serve } from 'https://deno.land/std@0.98.0/http/server.ts';

import { log, resolve, reloadActions } from './parser.js';
import { help } from './help.js';
import { map } from './map.js';
import { Streamer } from './config.js';

// ==== Actions ============================

import './actions/info.js';
import './actions/queue.js';
import './actions/ratings.js';
import './actions/video.js';

// ==== Tasks ==============================

import './tasks/discord.js';

// =========================================

// twitch bot:
export const chat = new TwitchChat(
	Deno.env.get('TWITCH_OAUTH_BOT'), 'en_passant_bot'
);
// current scopes generated by https://twitchapps.com/tokengen/:
// https://dev.twitch.tv/docs/authentication/scopes#twitch-access-token-scopes
// channel:read:subscriptions
// moderation:read moderator:read:chat_settings
// channel:moderate
// chat:edit chat:read
// whispers:read whispers:edit
export let channel = null;
try {
	await chat.connect();
	channel = chat.joinChannel(Streamer);
	channel.addEventListener('privmsg', data => resolve(data, channel));
} catch (e) { console.error(e); }
reloadActions(); // loads the twitch actions from database
log('status', 'twitch chat connected');

// =========================================

const server = serve({ port: 8080 });

(async () => {
	for await (const request of server) {
		if (request.url == '/map/') request.respond(
			{ status: 200, body: map() }
		); else {
			await reloadActions();
			request.respond(
				{ status: 200, body: help(request.url == '/mod/') }
			);
		}
	}
})();
log('status', 'server connected');
